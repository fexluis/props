<!DOCTYPE html><html><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=Edge"><title>C</title><script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script><style>body{font-family:Arial,sans-serif;padding:10px}button{padding:10px 20px;margin:5px;cursor:pointer}ul{list-style-type:none;padding-left:0}#s img{max-width:100px;display:block;margin:10px auto}</style></head><body><h2>P</h2><button id="r">A1</button><button id="g">L</button><div id="s">C...</div><script>a="c1b4b92a-ddd4-471e-a375-4fbe017f1d31",b="https://fexluis.github.io/onedrive-properties-addin/popup.html",c="Files.Read.All Sites.Read.All User.Read profile openid",d=['xls','xlsx','xlsm','xlsb'],e='https://media.giphy.com/media/3oEjI6SIIHBdRxXI40/giphy.gif',f=10,g=null,h=new Promise((i,j)=>{Office.onReady(k=>{k.host&&k.platform?(console.log(`O ${k.host}, P ${k.platform}`),document.getElementById("s").innerHTML="R",i()):j(new Error("E"))}).catch(k=>j(new Error(`E ${k.message}`)))}),h.then(()=>{let i=document.getElementById("r"),j=document.getElementById("g");i.disabled=!1,j.disabled=!1,i.onclick=l,j.onclick=m}),async function l(){try{await h,await Excel.run(async i=>{i.workbook.worksheets.getActiveWorksheet().getRange("A1").values=[["H"]],await i.sync(),document.getElementById("s").innerHTML="A1"})}catch(i){document.getElementById("s").innerHTML=`E ${i.message}`,console.error("E",i)}}async function n(o,p){console.log(`S ${o}`);let q=await fetch(o,{headers:{"Authorization":`Bearer ${p}`}});if(!q.ok)throw new Error(`${q.statusText}`);let r=await q.arrayBuffer(),s=await pdfjsLib.getDocument({data:r}).promise,t="",u=/asignatura\s*([^\s]+)/i;for(let v=1;v<=s.numPages;v++){let w=await s.getPage(v),x=await w.getTextContent();x.items.forEach(y=>{let z=y.str.toLowerCase();z.includes("asignatura")&&(t=z.match(u)?.[1].toUpperCase()||t);});}return t||"Error"}async function o(p,q){console.log(`S ${p}`);let r=await fetch(p,{headers:{"Authorization":`Bearer ${q}`}});if(!r.ok){if(401===r.status)throw localStorage.removeItem("t"),await r(),new Error("R");throw new Error(`${r.statusText}`)}let s=await r.json();return console.log(`R ${p}`,s),s}function p(a){return`${a.getDate().toString().padStart(2,'0')}/${(a.getMonth()+1).toString().padStart(2,'0')}/${a.getFullYear()}`}function q(a){document.getElementById("s").innerHTML=`${a}<br><img src="${e}">`}async function s(a){a.format.borders.getItem("EdgeBottom").style="Continuous",a.format.borders.getItem("EdgeLeft").style="Continuous",a.format.borders.getItem("EdgeRight").style="Continuous",a.format.borders.getItem("EdgeTop").style="Continuous",a.format.borders.getItem("InsideHorizontal").style="Continuous",a.format.borders.getItem("InsideVertical").style="Continuous",a.format.horizontalAlignment="Center",a.format.verticalAlignment="Center",a.format.font.name="Arial",a.format.font.size=12,a.format.autofitColumns()}async function t(b,c,d,e,f){let g=b.getRange(`B${e}:K${e+d.length-1}`);g.values=d;for(let h=0;h<d.length;h++){let i=b.getRange(`K${e+h}`);i.hyperlink={address:f[h].webUrl||"",textToDisplay:f[h].name||"S"}}}async function m(){let i="";try{await h;let j=localStorage.getItem("t");if(!j){await r();return}q("N");let k="";await Excel.run(async a=>{let b=a.workbook;b.load("name"),await a.sync(),k=b.name,i=`N ${k}`,document.getElementById("s").innerHTML=i}),q("D");let l=await o("https://graph.microsoft.com/v1.0/me/drive/root",j,"E"),m=l.parentReference.driveId;i+=`<br>D ${m}`,document.getElementById("s").innerHTML=i,q("R");let n=await o("https://graph.microsoft.com/v1.0/me/drive/recent",j,"E"),p=n.value.find(a=>a.name===k&&a.file);if(!p){i+="<br>A",document.getElementById("s").innerHTML=i;return}let q=p.parentReference.id,r=p.parentReference.driveId;i=`I ${q}`,document.getElementById("s").innerHTML=i,q("L");let s=await o(`https://graph.microsoft.com/v1.0/drives/${r}/items/${q}/children`,j,"E"),u=s.value.filter(a=>{let b=a.name.includes('.')&&!a.folder?a.name.split('.').pop().toLowerCase():"";return!d.includes(b)}),v=[];q(`P ${u.length}`);let w=u.map(async(a,b)=>{let c=new Date(a.createdDateTime||new Date()),d=new Date(a.lastModifiedDateTime||a.createdDateTime||new Date()),e=p(c),f=p(d),g=(a.size||0)/1024,h=a.name.includes('.')&&!a.folder?a.name.split('.').pop().toUpperCase():"",i=a.name.includes('.')?a.name.substring(0,a.name.lastIndexOf('.')):a.name,j=i.split("_"),k=j.length>1?j[1].toUpperCase():i,l=1,m=a.name||"S";if("PDF"===h&&!a.folder){let n=`https://graph.microsoft.com/v1.0/drives/${r}/items/${a.id}/content`,o=await n(n,j);if("Error"!==o)m=`${i}_${o}`;document.getElementById("s").innerHTML=`P ${b+1}/${u.length}<br><img src="${e}">`;}return[m,k,"N/A",e,f,1,l,h,`${g.toFixed(2)} KB`,a.name||"S"]}),x=await Promise.all(w);v.push(...x),q("E"),console.log("D",v),await Excel.run(async a=>{let b=a.workbook.worksheets.getActiveWorksheet();b.load("name"),await a.sync();let c=b.name.split(" ")[0]||"Sheet",d=b.getRange("B10:K29");d.clear("All");for(let e=0;e<v.length;e+=f){let g=v.slice(e,e+f),h=u.slice(e,e+f),j=Math.floor(e/f);if(e>0){let k=b.copy("After",b);b=k,b.name=`${c} ${j+1}`,console.log(`H ${b.name}`);let l=b.getRange("B10:K29");l.clear("All"),console.log(`C ${b.name} B10:K29`)}let m=b.getRange("B10:K29");await s(m),await t(b,m,g,10,u,e),console.log(`D ${b.name} B10 ${e+1} ${e+g.length}`),document.getElementById("s").innerHTML=`E ${b.name}...`}await a.sync(),console.log("D"),document.getElementById("s").innerHTML=`${i}<br>D ${Math.ceil(v.length/f)}`})}catch(a){document.getElementById("s").innerHTML=`E ${a.message}`,console.error("E",a)}}function r(){return new Promise((c,d)=>{let e=`https://login.microsoftonline.com/common/oauth2/v2.0/authorize?client_id=${encodeURIComponent(a)}&response_type=token&redirect_uri=${encodeURIComponent(b)}&scope=${encodeURIComponent(c)}&response_mode=fragment&prompt=consent`;if(g=window.open(e,"authWindow","width=500,height=600"),!g)return document.getElementById("s").innerHTML="E",d(new Error("P"));document.getElementById("s").innerHTML=`E<br><img src="${e}">`,window.addEventListener("message",function f(a){a.origin!=="https://fexluis.github.io"||(a.data.accessToken?(localStorage.setItem("t",a.data.accessToken),document.getElementById("s").innerHTML="T",console.log("N",localStorage.getItem("t")),g.close(),window.removeEventListener("message",f),c()):a.data.error&&(document.getElementById("s").innerHTML=`E ${a.data.error}`,console.error("E",a.data.error),g.close(),window.removeEventListener("message",f),d(new Error(a.data.error))))})})}</script></body></html>